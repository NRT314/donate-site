<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>NRT Donate</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    input[type="number"] { width: 80px; padding: 4px; }
    button { margin-top: 1rem; padding: 10px 20px; font-size: 16px; cursor: pointer; }
    #status { margin-top: 1rem; font-weight: bold; }
  </style>
</head>
<body>

  <h2>–û –ø—Ä–æ–µ–∫—Ç–µ</h2>
  <p>–ü–æ–∂–µ—Ä—Ç–≤—É–π—Ç–µ –≤ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∏ –ø–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω—ã <strong>NRT</strong> ‚Äî —Ü–∏—Ñ—Ä–æ–≤–æ–π –∞–∫—Ç–∏–≤, –¥–∞—é—â–∏–π —É—á–∞—Å—Ç–∏–µ –≤ –±—É–¥—É—â–µ–º DAO.</p>

  <h3>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞</h3>
  <button id="connectBtn">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª—ë–∫</button>
  <p id="walletAddress"></p>

  <h3>–°–¥–µ–ª–∞—Ç—å –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–µ</h3>
  <p>–°—É–º–º–∞ –≤ USDT —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –º–µ–∂–¥—É –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º–∏, –∫–æ—Ç–æ—Ä—ã–º –≤—ã —É–∫–∞–∂–µ—Ç–µ:</p>

  <table>
    <thead>
      <tr><th>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</th><th>–ê–¥—Ä–µ—Å</th><th>–°—É–º–º–∞ (USDT)</th></tr>
    </thead>
    <tbody id="donationRows"></tbody>
  </table>

  <button id="donateBtn">üí∏ –ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞—Ç—å</button>
  <p id="status"></p>

  <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.2/dist/ethers.umd.min.js"></script>
  <script>
    const CONTRACT_ADDRESS = "0x875eB740603Cd0eAE03caa99Dd2d0f23BE9B6BF5";
    const USDT_ADDRESS = "0xc2132D05D31c914a87C6611C10748AEb04B58e8F";

    const ABI = [
      "function donate(address token, address[] recipients, uint256[] amounts) external"
    ];

    const orgs = [
      ["–ü—Ä–æ–µ–∫—Ç (–æ—Å–Ω–æ–≤–Ω–æ–π)", "0xc0F467567570AADa929fFA115E65bB39066e3E42"],
      ["ovdinfo", "0xAc3A0a3a015Ad310F980dd84dD0B4fA167f94D83"],
      ["mediazona", "0xE86D7D922DeF8a8FEB21f1702C9AaEEDBec32DDC"],
      ["zhuk", "0x1913A02BB3836AF224aEF136461F43189A0cEcd0"],
      ["breakfastshow", "0xdB4BB555a15bC8bB3b07E57452a8E6E24b358e7F"],
      ["kovcheg", "0xBf178F99b8790db1BD2194D80c3a268AE4AcE804"],
      ["findexit", "0xADb524cE8c2009e727f6dF4b6a443D455c700244"],
      ["gulagunet", "0x6051F40d4eF5d5E5BC2B6F4155AcCF57Be6B8F58"],
      ["meduza", "0x00B9d7Fe4a2d3aCdd4102Cfb55b98d193B94C0fa"],
      ["cit", "0xfBcc8904ce75fF90CC741DA80703202faf5b2FcF"],
      ["importantstories", "0x5433CE0E05D117C54f814cc6697244eA0b902DBF"],
      ["fbk", "0x314aC71aEB2feC4D60Cc50Eb46e64980a27F2680"]
    ];

    let provider, signer;

    const connectBtn = document.getElementById("connectBtn");
    const donateBtn = document.getElementById("donateBtn");
    const walletAddressElem = document.getElementById("walletAddress");
    const statusElem = document.getElementById("status");
    const donationRows = document.getElementById("donationRows");

    const inputMap = new Map();

    orgs.forEach(([name, address]) => {
      const tr = document.createElement("tr");
      const input = document.createElement("input");
      input.type = "number";
      input.step = "0.01";
      input.min = "0";
      input.value = "0";
      inputMap.set(address, input);
      tr.innerHTML = `<td>${name}</td><td>${address}</td><td></td>`;
      tr.children[2].appendChild(input);
      donationRows.appendChild(tr);
    });

    connectBtn.onclick = async () => {
      if (!window.ethereum) return alert("–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ MetaMask –∏–ª–∏ Rabby");
      provider = new ethers.BrowserProvider(window.ethereum);
      const accounts = await provider.send("eth_requestAccounts", []);
      signer = await provider.getSigner();
      walletAddressElem.innerText = "–ö–æ—à–µ–ª—ë–∫: " + accounts[0];
      connectBtn.disabled = true;
    };

    donateBtn.onclick = async () => {
      if (!signer) return alert("–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫");

      const tokenContract = new ethers.Contract(USDT_ADDRESS, [
        "function approve(address spender, uint256 amount) public returns (bool)",
        "function decimals() view returns (uint8)"
      ], signer);

      const decimals = await tokenContract.decimals();

      const recipients = [];
      const amounts = [];
      let total = ethers.parseUnits("0", decimals);

      for (const [addr, input] of inputMap.entries()) {
        const val = parseFloat(input.value);
        if (val > 0) {
          const value = ethers.parseUnits(val.toString(), decimals);
          recipients.push(ethers.getAddress(addr)); // ‚úÖ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π checksum
          amounts.push(value);
          total += value;
        }
      }

      if (recipients.length === 0) return alert("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Ö–æ—Ç—è –±—ã –¥–ª—è –æ–¥–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏");

      try {
        statusElem.innerText = "‚è≥ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤ –∫–æ—à–µ–ª—å–∫–µ (approve)...";
        const approveTx = await tokenContract.approve(CONTRACT_ADDRESS, total);
        await approveTx.wait();

        const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
        statusElem.innerText = "‚è≥ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤ –∫–æ—à–µ–ª—å–∫–µ (donate)...";
        const tx = await contract.donate(USDT_ADDRESS, recipients, amounts);
        await tx.wait();

        statusElem.innerText = "‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –¥–æ–Ω–∞—Ç!";
      } catch (err) {
        console.error(err);
        statusElem.innerText = "‚ùå –û—à–∏–±–∫–∞: " + err.message;
      }
    };
  </script>
</body>
</html>
